<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pahana Combined Apps</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide icons for the book shop cart -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.279.0/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .app-container.hidden {
            display: none;
        }
        .view-section.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- Main Header Navigation for switching between apps -->
<header class="bg-white shadow-lg sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <!-- App Titles -->
            <div class="flex space-x-6">
                <button id="nav-billing-app" class="text-gray-900 font-bold px-3 py-2 rounded-md hover:bg-gray-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    PahanaEDU Billing
                </button>
                <button id="nav-book-shop-app" class="text-gray-900 font-bold px-3 py-2 rounded-md hover:bg-gray-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    Pahana Book Shop
                </button>
            </div>
        </div>
    </nav>
</header>

<!-- Main Content Area to hold the applications -->
<main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

    <!-- PahanaEDU Billing System Container -->
    <div id="billing-app-container" class="app-container">
        <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-xl p-8 space-y-8">
            <header class="text-center">
                <h1 class="text-4xl font-bold text-gray-900">PahanaEDU Billing System</h1>
                <p class="text-gray-500 mt-2">Manage customer profiles and bills in one place.</p>

                <nav class="mt-6 border-b border-gray-200">
                    <ul class="flex justify-center -mb-px text-sm font-medium">
                        <li>
                            <button id="nav-dashboard" class="inline-block p-4 border-b-2 border-transparent text-gray-600 hover:text-indigo-600 hover:border-gray-300 focus:outline-none">Customer Dashboard</button>
                        </li>
                        <li>
                            <button id="nav-register" class="inline-block p-4 border-b-2 border-transparent text-gray-600 hover:text-indigo-600 hover:border-gray-300 focus:outline-none">Register New Customer</button>
                        </li>
                    </ul>
                </nav>
            </header>

            <div id="customer-dashboard-view" class="view-section">
                <main class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-1 bg-gray-50 p-6 rounded-lg shadow-inner">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">All Customers</h2>
                        <div id="customer-list" class="space-y-3">
                            <p class="text-gray-400 text-center py-4">Loading customers...</p>
                        </div>
                    </div>

                    <div class="md:col-span-2 bg-white p-6 rounded-lg shadow">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Customer Profile</h2>
                        <div id="customer-profile-details" class="space-y-4">
                            <p class="text-gray-400 text-center py-16">Select a customer from the list to view their profile.</p>
                        </div>
                    </div>
                </main>
            </div>

            <div id="register-customer-view" class="view-section hidden">
                <div class="max-w-md mx-auto w-full bg-white rounded-lg p-8 space-y-6">
                    <h2 class="text-3xl font-bold text-gray-900 text-center">Register New Customer</h2>
                    <form id="registration-form" class="space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                            <input type="text" id="address" name="address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="mobileNumber" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                            <input type="tel" id="mobileNumber" name="mobileNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="telephoneNumber" class="block text-sm font-medium text-gray-700">Telephone Number (Optional)</label>
                            <input type="tel" id="telephoneNumber" name="telephoneNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>

                        <button type="submit" class="w-full bg-indigo-600 text-white font-medium py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Register Customer
                        </button>
                    </form>

                    <div id="status-message" class="mt-4 text-center text-sm"></div>
                </div>
            </div>
        </div>

        <div id="bill-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Create New Bill</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <form id="create-bill-form" class="space-y-4">
                    <div>
                        <label for="bill-units-consumed" class="block text-sm font-medium text-gray-700">Units Consumed</label>
                        <input type="number" id="bill-units-consumed" name="unitsConsumed" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="bill-item-id" class="block text-sm font-medium text-gray-700">Item ID</label>
                        <p class="text-xs text-gray-500 mb-1">Use a valid item ID from your database, e.g., '66a9a7a93a1f81498b58a183'</p>
                        <input type="text" id="bill-item-id" name="itemId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <input type="hidden" id="bill-customer-id">
                    <div class="flex justify-end pt-4">
                        <button type="submit" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Create Bill</button>
                    </div>
                </form>
                <div id="bill-form-message" class="mt-4 text-center text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Pahana Book Shop Container -->
    <div id="book-shop-container" class="app-container hidden">
        <!-- Header Navigation specific to the book shop -->
        <header class="bg-white shadow-lg sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Logo/Title -->
                    <a href="#" class="flex-shrink-0 flex items-center space-x-2" onclick="bookShop.showPage('home')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600">
                            <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20h-4a2 2 0 0 0-2-2H6.5a2.5 2.5 0 0 1 0-5H20"/>
                        </svg>
                        <span class="text-xl font-bold text-gray-900">Pahana Book Shop</span>
                    </a>

                    <!-- Navigation Links and Buttons -->
                    <div class="flex items-center space-x-4">
                        <button id="book-shop-cart-button" class="relative p-2 rounded-full text-gray-400 hover:text-indigo-600 hover:bg-gray-100 focus:outline-none transition-colors duration-200" onclick="bookShop.showPage('cart')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                                <circle cx="9" cy="21" r="1"></circle>
                                <circle cx="20" cy="21" r="1"></circle>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                            </svg>
                            <span id="book-shop-cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                        </button>
                        <button id="book-shop-auth-button" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" onclick="bookShop.showPage('login')">
                            Login / Register
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <!-- Home Page (Book List) -->
            <section id="book-shop-home-page" class="page">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Browse Our Books</h1>
                <div id="book-shop-book-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Book items will be dynamically inserted here by JavaScript -->
                </div>
            </section>

            <!-- Cart Page -->
            <section id="book-shop-cart-page" class="page hidden">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Your Shopping Cart</h1>
                <div id="book-shop-cart-items" class="bg-white rounded-lg shadow-md p-6">
                    <!-- Cart items will be dynamically inserted here -->
                </div>
                <div id="book-shop-cart-summary" class="mt-6 flex justify-between items-center bg-white rounded-lg shadow-md p-6">
                    <p class="text-xl font-semibold text-gray-900">Total: <span id="book-shop-cart-total" class="font-bold">Rs. 0.00</span></p>
                    <button id="book-shop-checkout-button" class="px-6 py-3 text-lg font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Proceed to Checkout
                    </button>
                </div>
            </section>

            <!-- Login/Register Page -->
            <section id="book-shop-login-page" class="page hidden">
                <div class="max-w-lg mx-auto bg-white rounded-lg shadow-lg p-8">
                    <h1 class="text-3xl font-bold text-gray-900 text-center mb-6">Login or Register</h1>

                    <!-- Registration Form -->
                    <div id="book-shop-registration-form-section">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Register for an Account</h2>
                        <form id="book-shop-registration-form" class="space-y-4">
                            <div>
                                <label for="book-shop-reg-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="book-shop-reg-name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="book-shop-reg-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" id="book-shop-reg-email" name="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="book-shop-reg-password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="book-shop-reg-password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">
                                Create Account
                            </button>
                        </form>
                        <p class="mt-4 text-sm text-gray-600 text-center">Already have an account? <a href="#" id="book-shop-show-login-btn" class="text-indigo-600 hover:text-indigo-800">Log in</a></p>
                    </div>

                    <!-- Login Form (Initially hidden) -->
                    <div id="book-shop-login-form-section" class="hidden">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Log in to Your Account</h2>
                        <form id="book-shop-login-form" class="space-y-4">
                            <div>
                                <label for="book-shop-login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" id="book-shop-login-email" name="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="book-shop-login-password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="book-shop-login-password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">
                                Log In
                            </button>
                        </form>
                        <p class="mt-4 text-sm text-gray-600 text-center">Don't have an account? <a href="#" id="book-shop-show-register-btn" class="text-indigo-600 hover:text-indigo-800">Register</a></p>
                    </div>

                    <!-- Status Message Area -->
                    <div id="book-shop-auth-status-message" class="mt-4 text-center text-sm"></div>
                </div>
            </section>

            <!-- Checkout Page (Guest or Logged-in) -->
            <section id="book-shop-checkout-page" class="page hidden">
                <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
                    <h1 class="text-3xl font-bold text-gray-900 text-center mb-6">Checkout</h1>
                    <div id="book-shop-checkout-summary" class="border-b pb-4 mb-4">
                        <h2 class="text-xl font-semibold mb-2">Order Summary</h2>
                        <div id="book-shop-checkout-items" class="space-y-2">
                            <!-- Items will be displayed here -->
                        </div>
                        <div class="mt-4 text-right text-lg font-bold">
                            Total: <span id="book-shop-checkout-total">Rs. 0.00</span>
                        </div>
                    </div>

                    <form id="book-shop-checkout-form" class="space-y-4">
                        <div id="book-shop-user-info-section">
                            <!-- User info (guest form or logged-in info) will be dynamically inserted here -->
                        </div>

                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">
                            Complete Purchase
                        </button>
                    </form>

                    <div id="book-shop-purchase-status-message" class="mt-4 text-center text-sm"></div>
                </div>
            </section>

            <!-- Confirmation Modal -->
            <div id="book-shop-confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center">
                    <h3 class="text-2xl font-bold text-green-600 mb-4">Purchase Successful!</h3>
                    <p id="book-shop-confirmation-message" class="text-gray-700 mb-6"></p>
                    <button onclick="bookShop.showPage('home')" class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Continue Shopping
                    </button>
                </div>
            </div>
        </main>
    </div>

</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- Main App Toggler Logic ---
        const billingAppContainer = document.getElementById('billing-app-container');
        const bookShopAppContainer = document.getElementById('book-shop-container');
        const navBillingBtn = document.getElementById('nav-billing-app');
        const navBookShopBtn = document.getElementById('nav-book-shop-app');
        const mainNavButtons = [navBillingBtn, navBookShopBtn];

        function showApp(appName) {
            billingAppContainer.classList.add('hidden');
            bookShopAppContainer.classList.add('hidden');
            mainNavButtons.forEach(btn => btn.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600'));

            if (appName === 'billing') {
                billingAppContainer.classList.remove('hidden');
                navBillingBtn.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600');
                initializeBillingApp();
            } else if (appName === 'bookshop') {
                bookShopAppContainer.classList.remove('hidden');
                navBookShopBtn.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600');
                initializeBookShopApp();
            }
        }

        navBillingBtn.addEventListener('click', () => showApp('billing'));
        navBookShopBtn.addEventListener('click', () => showApp('bookshop'));

        // --- PahanaEDU Billing System Logic ---
        function initializeBillingApp() {
            const dashboardView = document.getElementById('customer-dashboard-view');
            const registerView = document.getElementById('register-customer-view');
            const navDashboardBtn = document.getElementById('nav-dashboard');
            const navRegisterBtn = document.getElementById('nav-register');
            const navButtons = [navDashboardBtn, navRegisterBtn];

            function showBillingView(view) {
                dashboardView.classList.add('hidden');
                registerView.classList.add('hidden');
                navButtons.forEach(btn => btn.classList.remove('border-indigo-500', 'text-indigo-600', 'font-bold'));

                view.classList.remove('hidden');
                if (view === dashboardView) {
                    navDashboardBtn.classList.add('border-indigo-500', 'text-indigo-600', 'font-bold');
                    fetchCustomers();
                } else if (view === registerView) {
                    navRegisterBtn.classList.add('border-indigo-500', 'text-indigo-600', 'font-bold');
                }
            }

            navDashboardBtn.addEventListener('click', () => showBillingView(dashboardView));
            navRegisterBtn.addEventListener('click', () => showBillingView(registerView));

            const customerListEl = document.getElementById('customer-list');
            const profileDetailsEl = document.getElementById('customer-profile-details');
            const billModalEl = document.getElementById('bill-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const createBillForm = document.getElementById('create-bill-form');
            const billCustomerIdInput = document.getElementById('bill-customer-id');
            const billFormMessageEl = document.getElementById('bill-form-message');
            const registrationForm = document.getElementById('registration-form');
            const statusMessage = document.getElementById('status-message');

            const API_BASE_URL = 'http://localhost:8080/api';

            async function fetchCustomers() {
                try {
                    customerListEl.innerHTML = '<p class="text-gray-400 text-center py-4">Loading customers...</p>';
                    const url = `${API_BASE_URL}/customers`;
                    console.log(`[Billing App] Attempting to fetch from: ${url}`);
                    const response = await fetch(url);

                    if (response.status === 404) {
                        throw new Error(`Endpoint not found! Check your backend's API path or if the application is running correctly. Status: 404`);
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const customers = await response.json();
                    renderCustomerList(customers);
                } catch (error) {
                    console.error('[Billing App] Error fetching customers:', error);
                    customerListEl.innerHTML = `<p class="text-red-500 text-center py-4">Failed to load customers. Error: ${error.message}</p>`;
                }
            }

            function renderCustomerList(customerData) {
                if (customerData.length === 0) {
                    customerListEl.innerHTML = '<p class="text-gray-400 text-center py-4">No customers found.</p>';
                    return;
                }
                customerListEl.innerHTML = '';
                customerData.forEach(customer => {
                    const customerButton = document.createElement('button');
                    customerButton.className = 'w-full text-left p-3 rounded-md bg-white hover:bg-indigo-50 transition-colors duration-150 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500';
                    customerButton.innerHTML = `<p class="font-medium text-gray-900">${customer.name}</p><p class="text-sm text-gray-500">ID: ${customer.id}</p>`;
                    customerButton.addEventListener('click', () => fetchCustomerProfile(customer.id));
                    customerListEl.appendChild(customerButton);
                });
            }

            async function fetchCustomerProfile(customerId) {
                try {
                    profileDetailsEl.innerHTML = '<p class="text-gray-400 text-center py-16">Loading profile...</p>';
                    const url = `${API_BASE_URL}/customers/profile/${customerId}`;
                    console.log(`[Billing App] Attempting to fetch from: ${url}`);
                    const response = await fetch(url);

                    if (response.status === 404) {
                        throw new Error(`Endpoint not found! Check your backend's API path or if the application is running correctly. Status: 404`);
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const profile = await response.json();
                    renderCustomerProfile(profile);
                } catch (error) {
                    console.error('[Billing App] Error fetching customer profile:', error);
                    profileDetailsEl.innerHTML = `<p class="text-red-500 text-center py-16">Failed to load customer profile. Error: ${error.message}</p>`;
                }
            }

            function renderCustomerProfile(profile) {
                profileDetailsEl.innerHTML = '';
                if (!profile.customer) {
                    profileDetailsEl.innerHTML = '<p class="text-red-500 text-center py-16">Customer not found.</p>';
                    return;
                }

                profileDetailsEl.innerHTML += `
                        <div class="border-b pb-4 mb-4">
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${profile.customer.name}</h3>
                            <p class="text-gray-700"><span class="font-semibold">Account ID:</span> ${profile.customer.id}</p>
                            <p class="text-gray-700"><span class="font-semibold">Address:</span> ${profile.customer.address}</p>
                            <p class="text-gray-700"><span class="font-semibold">Mobile:</span> ${profile.customer.mobileNumber}</p>
                            <p class="text-gray-700"><span class="font-semibold">Units Consumed:</span> ${profile.customer.unitsConsumed}</p>
                        </div>
                    `;

                const createBillButton = document.createElement('button');
                createBillButton.className = 'bg-green-600 text-white font-medium py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500';
                createBillButton.textContent = 'Create New Bill';
                createBillButton.addEventListener('click', () => openBillModal(profile.customer.id));
                profileDetailsEl.appendChild(createBillButton);

                profileDetailsEl.innerHTML += `
                        <h3 class="text-xl font-bold text-gray-900 mt-6 mb-2">Billing History</h3>
                        <div id="bill-history" class="space-y-4"></div>
                    `;

                const billHistoryEl = document.getElementById('bill-history');
                if (profile.bills && profile.bills.length > 0) {
                    profile.bills.forEach(bill => {
                        const billEl = document.createElement('div');
                        billEl.className = 'p-4 border border-gray-200 rounded-md bg-white shadow-sm';
                        billEl.innerHTML = `
                                <p class="text-lg font-semibold text-gray-900">Amount: Rs. ${bill.amount.toFixed(2)}</p>
                                <p class="text-gray-600">Bill Date: ${bill.billDate}</p>
                                <p class="text-gray-600">Due Date: ${bill.dueDate}</p>
                                <p class="text-gray-600">Status: <span class="font-bold ${bill.status === 'PAID' ? 'text-green-600' : 'text-red-600'}">${bill.status}</span></p>
                                <p class="text-gray-600">Units Consumed: ${bill.unitsConsumed}</p>
                            `;
                        billHistoryEl.appendChild(billEl);
                    });
                } else {
                    billHistoryEl.innerHTML = '<p class="text-gray-400">No billing history found.</p>';
                }
            }

            function openBillModal(customerId) {
                billCustomerIdInput.value = customerId;
                billFormMessageEl.textContent = '';
                createBillForm.reset();
                billModalEl.classList.remove('hidden');
            }

            closeModalBtn.addEventListener('click', () => billModalEl.classList.add('hidden'));

            createBillForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                billFormMessageEl.textContent = 'Creating bill...';

                const customerId = billCustomerIdInput.value;
                const unitsConsumed = document.getElementById('bill-units-consumed').value;
                const itemId = document.getElementById('bill-item-id').value;

                const payload = { customerId, unitsConsumed: parseInt(unitsConsumed), itemId };

                try {
                    const url = `${API_BASE_URL}/bills/calculate`;
                    console.log(`[Billing App] Attempting to fetch from: ${url}`);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 404) {
                        throw new Error(`Endpoint not found! Check your backend's API path or if the application is running correctly. Status: 404`);
                    }
                    if (response.status === 201) {
                        billFormMessageEl.textContent = 'Bill created successfully!';
                        billFormMessageEl.className = 'mt-4 text-center text-sm text-green-600';
                        fetchCustomerProfile(customerId);
                        setTimeout(() => billModalEl.classList.add('hidden'), 2000);
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('[Billing App] Error creating bill:', error);
                    billFormMessageEl.textContent = `Error: ${error.message}`;
                    billFormMessageEl.className = 'mt-4 text-center text-sm text-red-600';
                }
            });

            registrationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                statusMessage.textContent = 'Registering...';
                statusMessage.className = 'mt-4 text-center text-sm text-gray-600';

                const formData = new FormData(registrationForm);
                const payload = Object.fromEntries(formData.entries());

                try {
                    const url = `${API_BASE_URL}/customers/register`;
                    console.log(`[Billing App] Attempting to fetch from: ${url}`);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 404) {
                        throw new Error(`Endpoint not found! Check your backend's API path or if the application is running correctly. Status: 404`);
                    }

                    if (response.ok) {
                        statusMessage.textContent = 'Customer registered successfully!';
                        statusMessage.className = 'mt-4 text-center text-sm text-green-600';
                        registrationForm.reset();
                    } else {
                        const errorText = await response.text();
                        throw new Error(errorText || `HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('[Billing App] Error registering customer:', error);
                    statusMessage.textContent = `Error: ${error.message}`;
                    statusMessage.className = 'mt-4 text-center text-sm text-red-600';
                }
            });

            showBillingView(dashboardView);
        }

        // --- Pahana Book Shop Logic ---
        const bookShop = (function() {
            // --- State Management ---
            let cart = JSON.parse(localStorage.getItem('bookShopCart')) || [];
            let user = JSON.parse(localStorage.getItem('bookShopUser')) || null;

            // --- Mock Data ---
            const mockBooks = [
                { id: 1, title: "The Martian", author: "Andy Weir", price: 1250, cover: "https://placehold.co/200x300/a855f7/ffffff?text=The+Martian" },
                { id: 2, title: "Dune", author: "Frank Herbert", price: 1800, cover: "https://placehold.co/200x300/3b82f6/ffffff?text=Dune" },
                { id: 3, title: "Project Hail Mary", author: "Andy Weir", price: 1500, cover: "https://placehold.co/200x300/22c55e/ffffff?text=Project+Hail+Mary" },
                { id: 4, title: "Neuromancer", author: "William Gibson", price: 1100, cover: "https://placehold.co/200x300/f59e0b/ffffff?text=Neuromancer" },
                { id: 5, title: "Foundation", author: "Isaac Asimov", price: 1650, cover: "https://placehold.co/200x300/ef4444/ffffff?text=Foundation" },
                { id: 6, title: "The Hitchhiker's Guide to the Galaxy", author: "Douglas Adams", price: 1000, cover: "https://placehold.co/200x300/ec4899/ffffff?text=Hitchhiker's+Guide" }
            ];

            // --- DOM Element References ---
            const pages = {
                'home': document.getElementById('book-shop-home-page'),
                'cart': document.getElementById('book-shop-cart-page'),
                'login': document.getElementById('book-shop-login-page'),
                'checkout': document.getElementById('book-shop-checkout-page')
            };
            const bookGridEl = document.getElementById('book-shop-book-grid');
            const cartItemsEl = document.getElementById('book-shop-cart-items');
            const cartTotalEl = document.getElementById('book-shop-cart-total');
            const cartCountEl = document.getElementById('book-shop-cart-count');
            const authButtonEl = document.getElementById('book-shop-auth-button');
            const checkoutItemsEl = document.getElementById('book-shop-checkout-items');
            const checkoutTotalEl = document.getElementById('book-shop-checkout-total');
            const userInfoSectionEl = document.getElementById('book-shop-user-info-section');
            const loginFormEl = document.getElementById('book-shop-login-form-section');
            const registerFormEl = document.getElementById('book-shop-registration-form-section');
            const confirmationModalEl = document.getElementById('book-shop-confirmation-modal');
            const confirmationMessageEl = document.getElementById('book-shop-confirmation-message');
            const checkoutFormEl = document.getElementById('book-shop-checkout-form');

            // --- UI Functions ---
            const updateCartCount = () => {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                cartCountEl.textContent = totalItems;
                cartCountEl.classList.toggle('hidden', totalItems === 0);
            };

            const updateAuthButton = () => {
                if (user) {
                    authButtonEl.textContent = `Welcome, ${user.name}`;
                    authButtonEl.disabled = true;
                    authButtonEl.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    authButtonEl.classList.add('bg-gray-400', 'cursor-not-allowed');
                } else {
                    authButtonEl.textContent = 'Login / Register';
                    authButtonEl.disabled = false;
                    authButtonEl.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    authButtonEl.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                }
            };

            const renderBooks = () => {
                bookGridEl.innerHTML = '';
                mockBooks.forEach(book => {
                    const bookEl = document.createElement('div');
                    bookEl.className = 'bg-white rounded-lg shadow-md overflow-hidden transition-transform duration-200 hover:scale-105';
                    bookEl.innerHTML = `
                            <img src="${book.cover}" alt="${book.title} cover" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="text-xl font-semibold text-gray-900">${book.title}</h3>
                                <p class="text-sm text-gray-500">${book.author}</p>
                                <p class="text-lg font-bold text-indigo-600 mt-2">Rs. ${book.price.toFixed(2)}</p>
                                <button class="mt-4 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200 add-to-cart-btn" data-id="${book.id}">
                                    Add to Cart
                                </button>
                            </div>
                        `;
                    bookGridEl.appendChild(bookEl);
                });
            };

            const renderCart = () => {
                cartItemsEl.innerHTML = '';
                let total = 0;
                if (cart.length === 0) {
                    cartItemsEl.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty.</p>';
                    document.getElementById('book-shop-checkout-button').disabled = true;
                    document.getElementById('book-shop-checkout-button').classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    document.getElementById('book-shop-checkout-button').disabled = false;
                    document.getElementById('book-shop-checkout-button').classList.remove('opacity-50', 'cursor-not-allowed');
                    cart.forEach(item => {
                        const book = mockBooks.find(b => b.id === item.id);
                        if (book) {
                            const itemPrice = book.price * item.quantity;
                            total += itemPrice;
                            const cartItemEl = document.createElement('div');
                            cartItemEl.className = 'flex items-center justify-between border-b pb-4 mb-4 last:border-b-0 last:mb-0';
                            cartItemEl.innerHTML = `
                                    <div class="flex items-center space-x-4">
                                        <img src="${book.cover}" alt="${book.title}" class="w-16 h-20 object-cover rounded-md shadow-sm">
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900">${book.title}</h3>
                                            <p class="text-sm text-gray-500">Qty: ${item.quantity} x Rs. ${book.price.toFixed(2)}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <p class="font-bold text-indigo-600">Rs. ${itemPrice.toFixed(2)}</p>
                                        <button class="remove-from-cart-btn text-red-500 hover:text-red-700" data-id="${book.id}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M18 6L6 18"></path><path d="M6 6L18 18"></path>
                                            </svg>
                                        </button>
                                    </div>
                                `;
                            cartItemsEl.appendChild(cartItemEl);
                        }
                    });
                }
                cartTotalEl.textContent = `Rs. ${total.toFixed(2)}`;
            };

            const renderCheckout = () => {
                checkoutItemsEl.innerHTML = '';
                let total = 0;
                if (cart.length === 0) {
                    checkoutItemsEl.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty. Please add items to checkout.</p>';
                    checkoutFormEl.classList.add('hidden');
                    return;
                }
                checkoutFormEl.classList.remove('hidden');
                cart.forEach(item => {
                    const book = mockBooks.find(b => b.id === item.id);
                    if (book) {
                        const itemPrice = book.price * item.quantity;
                        total += itemPrice;
                        const checkoutItemEl = document.createElement('div');
                        checkoutItemEl.className = 'flex justify-between items-center';
                        checkoutItemEl.innerHTML = `
                                <p class="text-gray-700">${book.title} (x${item.quantity})</p>
                                <p class="font-bold text-gray-900">Rs. ${itemPrice.toFixed(2)}</p>
                            `;
                        checkoutItemsEl.appendChild(checkoutItemEl);
                    }
                });
                checkoutTotalEl.textContent = `Rs. ${total.toFixed(2)}`;

                userInfoSectionEl.innerHTML = '';
                if (user) {
                    userInfoSectionEl.innerHTML = `
                            <h2 class="text-xl font-semibold text-gray-800 mb-2">Customer Information</h2>
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="font-medium text-gray-900">${user.name}</p>
                                <p class="text-sm text-gray-600">${user.email}</p>
                            </div>
                        `;
                } else {
                    userInfoSectionEl.innerHTML = `
                            <h2 class="text-xl font-semibold text-gray-800 mb-2">Guest Information</h2>
                            <p class="text-sm text-gray-600 mb-4">You are checking out as a guest. You can register for an account on the login page.</p>
                            <form id="book-shop-guest-checkout-form" class="space-y-4">
                                <div>
                                    <label for="book-shop-guest-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" id="book-shop-guest-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                                </div>
                                <div>
                                    <label for="book-shop-guest-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                                    <input type="email" id="book-shop-guest-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                                </div>
                            </form>
                        `;
                }
            };

            // --- Core Logic Functions ---
            const showPage = (pageName) => {
                Object.values(pages).forEach(page => page.classList.add('hidden'));
                pages[pageName].classList.remove('hidden');

                if (pageName === 'home') {
                    renderBooks();
                } else if (pageName === 'cart') {
                    renderCart();
                } else if (pageName === 'checkout') {
                    renderCheckout();
                }
            };

            const addToCart = (bookId) => {
                const item = cart.find(i => i.id === bookId);
                if (item) {
                    item.quantity++;
                } else {
                    cart.push({ id: bookId, quantity: 1 });
                }
                localStorage.setItem('bookShopCart', JSON.stringify(cart));
                updateCartCount();
            };

            const removeFromCart = (bookId) => {
                cart = cart.filter(item => item.id !== bookId);
                localStorage.setItem('bookShopCart', JSON.stringify(cart));
                updateCartCount();
                renderCart();
            };

            // --- Event Listeners ---
            document.getElementById('book-shop-book-grid').addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    const bookId = parseInt(e.target.dataset.id);
                    addToCart(bookId);
                }
            });

            document.getElementById('book-shop-cart-items').addEventListener('click', (e) => {
                if (e.target.closest('.remove-from-cart-btn')) {
                    const bookId = parseInt(e.target.closest('.remove-from-cart-btn').dataset.id);
                    removeFromCart(bookId);
                }
            });

            document.getElementById('book-shop-checkout-button').addEventListener('click', () => {
                showPage('checkout');
            });

            document.getElementById('book-shop-registration-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('book-shop-reg-name').value;
                const email = document.getElementById('book-shop-reg-email').value;

                user = { name, email };
                localStorage.setItem('bookShopUser', JSON.stringify(user));

                document.getElementById('book-shop-auth-status-message').className = 'mt-4 text-center text-sm text-green-600';
                document.getElementById('book-shop-auth-status-message').textContent = `Registration successful! Welcome, ${user.name}.`;

                updateAuthButton();
                showPage('home');
            });

            document.getElementById('book-shop-login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('book-shop-login-email').value;

                user = { name: 'Test User', email: email };
                localStorage.setItem('bookShopUser', JSON.stringify(user));

                document.getElementById('book-shop-auth-status-message').className = 'mt-4 text-center text-sm text-green-600';
                document.getElementById('book-shop-auth-status-message').textContent = `Login successful! Welcome, ${user.name}.`;

                updateAuthButton();
                showPage('home');
            });

            document.getElementById('book-shop-show-login-btn').addEventListener('click', (e) => {
                e.preventDefault();
                registerFormEl.classList.add('hidden');
                loginFormEl.classList.remove('hidden');
            });

            document.getElementById('book-shop-show-register-btn').addEventListener('click', (e) => {
                e.preventDefault();
                loginFormEl.classList.add('hidden');
                registerFormEl.classList.remove('hidden');
            });

            checkoutFormEl.addEventListener('submit', (e) => {
                e.preventDefault();
                const purchaseStatusEl = document.getElementById('book-shop-purchase-status-message');

                if (cart.length === 0) {
                    purchaseStatusEl.textContent = 'Your cart is empty!';
                    purchaseStatusEl.className = 'mt-4 text-center text-sm text-red-600';
                    return;
                }

                cart = [];
                localStorage.removeItem('bookShopCart');

                confirmationModalEl.classList.remove('hidden');
                let message = "Your order has been placed successfully!";
                if (user) {
                    message += ` Thank you for your purchase, ${user.name}.`;
                } else {
                    const guestName = document.getElementById('book-shop-guest-name').value;
                    if(guestName) {
                        message += ` Thank you for your purchase, ${guestName}.`;
                    }
                }
                confirmationMessageEl.textContent = message;
                updateCartCount();
            });

            // --- Public API for the book shop module ---
            return {
                showPage,
                updateCartCount,
                updateAuthButton
            };
        })();

        function initializeBookShopApp() {
            bookShop.showPage('home');
            bookShop.updateCartCount();
            bookShop.updateAuthButton();
        }

        // --- Initial app load ---
        showApp('billing');
    });
</script>
</body>
</html>
